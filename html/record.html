<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>

<body>
  <input type="checkbox" id="chk-hear-mic" /> <label for="chk-hear-mic">마이크 소리 듣기</label>
  <button id="record">녹음</button>
  <button id="stop">정지</button>
  <div id="sound-clips"></div>
  <script>
    const record = document.querySelector('#record');
    const stop = document.querySelector('#stop');
    const soundClips = document.querySelector('#sound-clips');
    const chkHearMic = document.querySelector('#chk-hear-mic');

    //const autioCtx = new (window.AudioContext || window.webkitAudioContext)(); //오디오 컨텍스트 정의
    const audioCtx = new window.AudioContext();

    //const analyser = audioCtx.createAnalyser();
    //const distortion = audioCtx.createWaveShaper();
    //const gainNode = audioCtx.createGain();
    //const biquadFilter = audioCtx.createBiquadFilter();

    //스피커에 stream 전달하는 함수
    function makeSound(stream) {
      const source = audioCtx.createMediaStreamSource(stream);
      source.connect(analyser);

      //analyser.connect(distortion)
      //distortion.connect(biquadFilter)
      //biquadFilter.connect(gainNode)
      //gainNode.connect(audioCtx.destination) // connecting the different audio graph nodes together

      analyser.connect(audioCtx.destination);
    }

    if (!navigator.mediaDevices) throw new Exception();

    console.log("getUserMedia supported.");
    const constraints = {
      audio: true
    };
    let chunks = [];

    //stream이 마이크에서 넘어오는 소리 캡쳐하는듯
    navigator.mediaDevices.getUserMedia(constraints).then((stream) => {
      const mediaRecorder = new MediaRecorder(stream);
      chkHearMic.onchange = (e) => {
        if (e.target.checked) {  //체크박스 체크되어 있으면
          audioCtx.resume();
          makeSound(stream);
        } else {
          audioCtx.suspend();
        }
      }

      record.onclick = () => {
        mediaRecorder.start(); //녹음 시작
        console.log(mediaRecorder.state);
        console.log("recorder started");
        record.style.background = "red";
        record.style.color = "black";
      }

      stop.onclick = () => {
        mediaRecorder.stop();
        console.log(mediaRecorder.state);
        console.log("recorder stopped");
        record.style.background = "";
        record.style.color = "";
      }

      //재생 영역 만들기
      mediaRecorder.onstop = (e) => {
        const clipName = "test "+new Date();
        const clipContainer = document.createElement("article");
        const clipLabel = document.createElement('p');
        const audio = document.createElement('audio');  //이게 재생 정지버튼 있는 플레이어구나
        const deleteButton = document.createElement('button');

        clipContainer.appendChild(audio);
        clipContainer.appendChild(clipLabel);
        clipContainer.appendChild(deleteButton);
        soundClips.appendChild(clipContainer);

        audio.controls = true;
        const blob = new Blob(chunks, {type : "audio/ogg codecs=opus"});
        chunks = [];
        const audioURL = URL.createObjectURL(blob);
        audio.src = audioURL;

        deleteButton.onclick = (e) => {
          evtTgt = e.target;
          evtTgt.parentNode.parentNode.removeChild(evtTgt.parentNode);
        }

      }

      //스트림을 받아오는 녀석인가?
      mediaRecorder.ondataavailable = (e) => {
        console.log('a');
        chunks.push(e.data);
      }


    })
    .catch((err)=> {
      console.log(err);
    });

  </script>
</body>

</html>